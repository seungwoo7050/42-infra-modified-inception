# Inception v0.1.0 — App + DB Matrix (Spring Boot)

## 개요
간결하고 실용적인 로컬/CI용 App+DB 스택 설계다. 이 버전은 백엔드 애플리케이션을 Spring Boot(Java 17)로 표준화하고, 데이터베이스로 MySQL과 PostgreSQL(둘 다)을 지원한다. 개발/테스트 목적에 따라 단일 DB 모드, 매트릭스 비교 모드, 또는 앱에서 두 DB에 동시에 연결해 자동 비교하는 멀티-DataSource 모드를 선택해 사용할 수 있다.

## 목표
- 동일한 애플리케이션 이미지로 MySQL과 PostgreSQL을 검증·비교할 수 있게 한다.
- 로컬 개발과 CI(매트릭스 테스트)에서 재현 가능한 구성 제공.
- DB별 스키마 초기화와 마이그레이션 전략을 명확히 한다.

## 범위
- 서비스: `app` (Spring Boot), `db-mysql` (MySQL 8+), `db-postgres` (Postgres 13+/15+)
- 모드:
  - 단일-DB 모드: 개발·디버깅용(한 번에 하나의 DB 사용)
  - 매트릭스 모드: CI/비교용(두 DB를 각각 연결한 앱 인스턴스 또는 연속 실행)
  - 멀티-DataSource 모드: 동일 프로세스가 두 DB를 동시에 연결해 자동 비교

## 핵심 설계 원칙
- 하나의 애플리케이션 이미지를 빌드하고, 환경변수로 DB 연결을 전환한다(이미지 재생성 불필요).
- DB 초기화는 각 DB의 표준 초기화 메커니즘 또는 마이그레이션 도구로 처리한다(Liquibase/Flyway 권장).
- CI는 DB별 매트릭스(job)를 사용해 통합 테스트를 병렬 또는 순차 검증한다.

## 구성 요소
- `services/app/`
  - Spring Boot 프로젝트(Gradle 또는 Maven)
  - 환경: `SPRING_DATASOURCE_URL` 또는 멀티-DataSource용 `SPRING_DATASOURCE_URL_PRIMARY`/`SECONDARY`
  - 엔드포인트: `/`(앱 상태), `/health-db`(단일 DB 헬스), `/compare-db`(멀티-DataSource 비교, 옵션)
- `docker-compose.yml` (단일-DB 기본)
- `docker-compose-matrix.yml` (매트릭스/비교용)
- DB 초기화 스크립트
  - `services/db/init.sql` (MySQL)
  - `services/db/init-postgres.sql` (Postgres)

## 실행 모드 요약
1. 단일-DB (로컬 빠른 시작)
   - `docker compose up --build -d`
   - 기본은 MySQL(`db-mysql`) 연결
2. 매트릭스 (동시 비교)
   - `docker compose -f docker-compose-matrix.yml up --build -d`
   - `app-mysql` / `app-postgres` 인스턴스를 통해 비교
3. 멀티-DataSource (앱 내부 비교)
   - 앱이 `DB_TYPE=both` 또는 `SPRING_DATASOURCE_URL_PRIMARY`/`SECONDARY`를 받아 두 DB에 동시에 연결
   - `curl /compare-db`로 비교 리포트 확인

## Config (권장 환경변수)
- 공통
  - `SPRING_PROFILES_ACTIVE` (dev/ci/prod)
  - `PORT` (기본 8080)
- 단일/매트릭스 모드
  - `SPRING_DATASOURCE_URL` (예: `jdbc:mysql://db-mysql:3306/appdb`)
- 멀티-DataSource 모드
  - `SPRING_DATASOURCE_URL_PRIMARY` (MySQL)
  - `SPRING_DATASOURCE_URL_SECONDARY` (Postgres)
  - `DB_USER`, `DB_PASSWORD`

## 초기화 & 마이그레이션
- 간단한 PoC: DB별 SQL 파일을 `/docker-entrypoint-initdb.d`에 배치
- 권장: Liquibase 또는 Flyway로 스키마·마이그레이션 관리
- 주의: 공식 이미지 초기화 스크립트는 "빈 데이터 디렉터리"에서만 실행됨(개발 반복시 볼륨 초기화 필요)

## 멀티-DataSource (디자인 요약)
### 목적
- 동일한 쿼리·스키마를 두 DB에서 실행해 데이터·타입·정렬·성능 차이를 자동으로 비교하기 위함

### 구성
- 앱에 두 개의 `DataSource` 빈을 등록: `primary`(MySQL), `secondary`(Postgres)
- 각각에 `JdbcTemplate` 또는 JPA `EntityManager` 바인딩
- `/compare-db` 엔드포인트가 동일한 검증 쿼리를 두 DB에 실행하고 JSON 형식으로 결과 비교 리포트를 반환

### 비교 리포트(권장 필드)
- `query` : 실행한 쿼리
- `primary` / `secondary` : 각 DB의 응답(건수, 샘플 행, 응답시간)
- `diff` : 발견된 차이 요약(타입 불일치, 값 불일치, 수량 불일치)
- `status` : `ok` / `mismatch` / `error`

### 구현 단계
1. `.env.example`에 멀티-DataSource 변수 추가
2. Spring Boot에서 두 DataSource 설정 및 `JdbcTemplate` 빈 추가
3. `/compare-db` 컨트롤러 구현(간단 쿼리부터 확장)
4. `docker-compose-matrix.yml`에 `app-compare` 서비스 예시 추가
5. CI: 비교 결과를 기준으로 실패 조건 정의(예: `diff` 존재 시 실패)

## 테스트 전략
- 로컬: `docker compose up --build -d` (단일-DB) → `/health-db` 확인
- 비교(매트릭스): `docker compose -f docker-compose-matrix.yml up --build -d` → 앱 로그/compare endpoint 확인
- CI: 매트릭스(job)로 MySQL/Postgres 각각 실행해 통합 테스트, 멀티-DataSource 모드는 별도 job으로 실행

## CI 권장 흐름(예시)
- matrix: `DB_TYPE: [mysql, postgres]`
- job steps: checkout → build → docker compose up (해당 db) → run integration tests → docker compose down -v
- optional: `compare` job that runs `app-compare` and uploads a diff report artifact

## 체크리스트 (핸드오프 전)
- [ ] `services/db/init.sql` 및 `init-postgres.sql` 준비
- [ ] `services/app/.env.example`에 멀티-DataSource 항목 명시
- [ ] `docker-compose-matrix.yml` 검증(포트/volumes 설정)
- [ ] CI 워크플로 템플릿 초안 준비

## 다음 단계 권장 (우선순위)
1. 멀티-DataSource PoC 구현(`services/app`에 비교 컨트롤러 추가)
2. CI 매트릭스 워크플로 템플릿 추가
3. Liquibase/Flyway 도입 검토 및 샘플 마이그레이션 스크립트 작성

---

새 파일로 `design/v0.1.0-app-db-matrix.md`를 생성했다. 다음으로 PoC 구현을 진행할까, 아니면 CI 템플릿 먼저 만들까?
